# サンプリング

サーバーがLLMから補完をリクエストできるようにする

サンプリングは、サーバーがクライアントを通じてLLM補完をリクエストできるようにするMCPの強力な機能で、セキュリティとプライバシーを維持しながら高度なエージェント的な動作を可能にします。

MCPのこの機能は、現在Claude Desktopクライアントではサポートされていません。

## サンプリングの仕組み

サンプリングのフローは以下のステップに従います：

1. サーバーが`sampling/createMessage`リクエストをクライアントに送信
2. クライアントがリクエストをレビューし、修正可能
3. クライアントがLLMからサンプリング
4. クライアントが補完をレビュー
5. クライアントが結果をサーバーに返す

このヒューマンインザループの設計により、ユーザーはLLMが見て生成するものを制御できます。

## メッセージフォーマット

サンプリングリクエストは標準化されたメッセージフォーマットを使用します：

```json
{
  messages: [
    {
      role: "user" | "assistant",
      content: {
        type: "text" | "image",

        // テキストの場合：
        text?: string,

        // 画像の場合：
        data?: string,             // base64エンコード
        mimeType?: string
      }
    }
  ],
  modelPreferences?: {
    hints?: [{
      name?: string                // 提案されるモデル名/ファミリー
    }],
    costPriority?: number,         // 0-1、コスト最小化の重要性
    speedPriority?: number,        // 0-1、低レイテンシーの重要性
    intelligencePriority?: number  // 0-1、能力の重要性
  },
  systemPrompt?: string,
  includeContext?: "none" | "thisServer" | "allServers",
  temperature?: number,
  maxTokens: number,
  stopSequences?: string[],
  metadata?: Record<string, unknown>
}
```

## リクエストパラメータ

### メッセージ

`messages`配列には、LLMに送信する会話履歴が含まれます。各メッセージには以下があります：

* `role`：「user」または「assistant」
* `content`：メッセージの内容、以下のいずれかになります：
  * `text`フィールドを持つテキストコンテンツ
  * `data`（base64）と`mimeType`フィールドを持つ画像コンテンツ

### モデル設定

`modelPreferences`オブジェクトにより、サーバーはモデル選択の設定を指定できます：

* `hints`：クライアントが適切なモデルを選択するために使用できるモデル名の提案の配列：
  * `name`：完全または部分的なモデル名と一致する文字列（例：「claude-3」、「sonnet」）
  * クライアントはヒントを異なるプロバイダーの同等のモデルにマッピングする場合があります
  * 複数のヒントは優先順位で評価されます

* 優先度値（0-1で正規化）：
  * `costPriority`：コスト最小化の重要性
  * `speedPriority`：低レイテンシー応答の重要性
  * `intelligencePriority`：高度なモデル機能の重要性

クライアントは、これらの設定と利用可能なモデルに基づいて最終的なモデル選択を行います。

### システムプロンプト

オプションの`systemPrompt`フィールドにより、サーバーは特定のシステムプロンプトをリクエストできます。クライアントはこれを変更または無視する場合があります。

### コンテキスト含有

`includeContext`パラメータは、どのMCPコンテキストを含めるかを指定します：

* `"none"`：追加のコンテキストなし
* `"thisServer"`：リクエスト元サーバーからのコンテキストを含める
* `"allServers"`：接続されているすべてのMCPサーバーからのコンテキストを含める

クライアントは、実際に含まれるコンテキストを制御します。

### サンプリングパラメータ

LLMサンプリングを微調整するには：

* `temperature`：ランダム性を制御（0.0から1.0）
* `maxTokens`：生成する最大トークン数
* `stopSequences`：生成を停止するシーケンスの配列
* `metadata`：プロバイダー固有の追加パラメータ

## レスポンスフォーマット

クライアントは補完結果を返します：

```json
{
  model: string,  // 使用されたモデルの名前
  stopReason?: "endTurn" | "stopSequence" | "maxTokens" | string,
  role: "user" | "assistant",
  content: {
    type: "text" | "image",
    text?: string,
    data?: string,
    mimeType?: string
  }
}
```

## リクエスト例

以下はクライアントからサンプリングをリクエストする例です：

```json
{
  "method": "sampling/createMessage",
  "params": {
    "messages": [
      {
        "role": "user",
        "content": {
          "type": "text",
          "text": "現在のディレクトリにはどのようなファイルがありますか？"
        }
      }
    ],
    "systemPrompt": "あなたは役立つファイルシステムアシスタントです。",
    "includeContext": "thisServer",
    "maxTokens": 100
  }
}
```

## ベストプラクティス

サンプリングを実装する際には：

1. 常に明確で構造化されたプロンプトを提供する
2. テキストと画像の両方のコンテンツを適切に処理する
3. 合理的なトークン制限を設定する
4. `includeContext`を通じて関連するコンテキストを含める
5. 使用前にレスポンスを検証する
6. エラーを適切に処理する
7. サンプリングリクエストのレート制限を検討する
8. 期待されるサンプリング動作をドキュメント化する
9. 様々なモデルパラメータでテストする
10. サンプリングコストを監視する

## ヒューマンインザループコントロール

サンプリングはヒューマンオーバーサイトを念頭に設計されています：

### プロンプトに対して

* クライアントはユーザーに提案されたプロンプトを表示すべき
* ユーザーはプロンプトを変更または拒否できるべき
* システムプロンプトはフィルタリングまたは変更される場合がある
* コンテキスト含有はクライアントによって制御される

### 補完に対して

* クライアントはユーザーに補完を表示すべき
* ユーザーは補完を変更または拒否できるべき
* クライアントは補完をフィルタリングまたは変更できる
* ユーザーはどのモデルが使用されるかを制御する

## セキュリティの考慮事項

サンプリングを実装する際には：

* すべてのメッセージコンテンツを検証する
* 機密情報をサニタイズする
* 適切なレート制限を実装する
* サンプリングの使用を監視する
* 転送中のデータを暗号化する
* ユーザーデータのプライバシーを処理する
* サンプリングリクエストを監査する
* コスト露出を制御する
* タイムアウトを実装する
* モデルエラーを適切に処理する

## 一般的なパターン

### エージェント的ワークフロー

サンプリングは以下のようなエージェント的パターンを可能にします：

* リソースの読み取りと分析
* コンテキストに基づく意思決定
* 構造化データの生成
* 複数ステップのタスクの処理
* インタラクティブな支援の提供

### コンテキスト管理

コンテキストのベストプラクティス：

* 必要最小限のコンテキストをリクエストする
* コンテキストを明確に構造化する
* コンテキストサイズの制限を処理する
* 必要に応じてコンテキストを更新する
* 古いコンテキストをクリーンアップする

### エラー処理

堅牢なエラー処理は以下を行うべきです：

* サンプリングの失敗をキャッチする
* タイムアウトエラーを処理する
* レート制限を管理する
* レスポンスを検証する
* フォールバック動作を提供する
* エラーを適切にログに記録する

## 制限事項

以下の制限事項に注意してください：

* サンプリングはクライアント機能に依存する
* ユーザーがサンプリング動作を制御する
* コンテキストサイズには制限がある
* レート制限が適用される場合がある
* コストを考慮すべき
* モデルの可用性は様々
* 応答時間は様々
* すべてのコンテンツタイプがサポートされているわけではない
